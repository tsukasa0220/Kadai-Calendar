<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Kadai-Calendar</title>
    <base target="_top">
    <?!= include('css'); ?>
</head>
<body>
<div role="main"><span id="maincontent"></span><div class="my-1 my-sm-5"></div>
<div class="row justify-content-center">
<div class="gc-wrap">
  <div id="calendar" class="g-calendar"></div>
</div>
<div class="col-xl-6 col-sm-8 ">
<div class="card">
  <div class="card-block">
    <h1 class="h2 card-header text-center" aria-label="香川大学 Moodle: ログイン">Kadai-Calendar</h1>
    <div class="card-body"><b>
      <div id="inResponse"><br></div>
      <div class="row justify-content-md-center">
        <div class="col-md-5">
          <button type="button" id="lock-calendar" class="btn btn-primary lock-click btn-block mt-3" onclick="update_calendar_EV()">カレンダー更新</button>
          <button type="button" id="lock-logout" class="btn btn-logout lock-click btn-block mt-3" onclick="logout_EV()">登録解除</button>
        </div>
        <div class="col-md-5">
          <div class="mt-3">
            <p>※注意書き<br>システムの不具合によって課題が出せなかったなどのトラブルに関しては一切保証できません<br>おねしゃす  by強欲</p>
            <p>バージョン0.9.0(ベータ版)</p>
          </div>
        </div>    
      </div>
    </div>
  </div>
</div>
</div>
</div>
</div>

<script>  
    window.onload = function() {
      google.script.run.withSuccessHandler(onload_result).onload();
    }
    function onload_result(n) {
      const inResponse = document.getElementById('inResponse');
      inResponse.innerHTML = `<center><div class="mt-3">学籍番号[${n[0]}]で登録されています</div></center>`;
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = `<iframe src="https://calendar.google.com/calendar/embed?src=${n[1]}&ctz=Asia%2FTokyo" style="border: 0" width="600" height="500" frameborder="0" scrolling="no"></iframe>`;
    }
</script>
</body>
<script>

    function update_calendar_EV() {
      const response = confirm("カレンダーを更新しますか？");     
      if (response) { 
        document.getElementById("lock-calendar").disabled = true;
        document.getElementById("lock-logout").disabled = true;
        const inResponse = document.getElementById('inResponse');
        inResponse.innerHTML = `<center><div class="mt-3">カレンダーを更新中...</div></center>`;
        google.script.run.withSuccessHandler(update_calendar_result).update_calendar();}
    }

    function logout_EV() {
      const response = confirm("登録を解除しますか？\n（登録されたデータは削除されますが念のためGoogleアカウントの管理から「Kadai-Calendar」のアクセス権を削除してください）");
      
      if (response) {
        document.getElementById("lock-calendar").disabled = true;
        document.getElementById("lock-logout").disabled = true;
        const inResponse = document.getElementById('inResponse');
        inResponse.innerHTML = `<center><div class="mt-3">カレンダーを削除中...</div></center>`;
        google.script.run.withSuccessHandler(logout_result).logout();
      }    
    }

    function update_calendar_result(n){
      const inResponse = document.getElementById('inResponse');
      if (n[0] == -1) {
        inResponse.innerHTML = `<div id="error" class="loginerrors mt-3"><div class="alert alert-danger" role="alert" data-aria-autofocus="true"><center>すでに登録が解除されています　ページを更新してください</center></div></div>`;
      } else {
        alert(n[0] + "個のイベントを追加しました");
        inResponse.innerHTML = `<center><div class="mt-3 alert-success">カレンダーを更新しました</div></center>`;
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = `<iframe src="https://calendar.google.com/calendar/embed?src=${n[1]}&ctz=Asia%2FTokyo" style="border: 0" width="800" height="600" frameborder="0" scrolling="no"></iframe>
`;
      }
      document.getElementById("lock-calendar").disabled = false;
      document.getElementById("lock-logout").disabled = false;
      
    }

    function logout_result(n) {
      const inResponse = document.getElementById('inResponse');
      if (n == -1) {
        inResponse.innerHTML = `<div id="error" class="loginerrors mt-3"><div class="alert alert-danger" role="alert" data-aria-autofocus="true"><center>すでに登録が解除されています　ページを更新してください</center></div></div>`;
      } else {
        alert("登録を解除しました");
        inResponse.innerHTML = `<center><div class="mt-3 alert-success">登録を解除しました　ページを更新してください</div></center>`;
      }
      document.getElementById("lock-calendar").disabled = false;
      document.getElementById("lock-logout").disabled = false;
    }
</script>
</html>