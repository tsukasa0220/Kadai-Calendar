<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Kadai-Calendar</title>
    <base target="_top">
    <?!= include('css_primary'); ?>
</head>
<body>
<div role="main">
  <span id="maincontent"></span>
  <div class="my-1 my-sm-5"></div>
<div class="row justify-content-center">
<div class="gc-wrap">
  <div id="inCalendar" class="g-calendar"></div>
</div>
<div class="col-xl-6 col-sm-8 ">
<div class="card">
  <div class="card-block">
    <h1 class="h2 card-header text-center">Kadai-Calendar</h1>
    <div class="card-body"><b>
      <div id="inResponse"><br></div>
      <div class="row justify-content-md-center">
        <div class="col-md-5">
          <button type="button" id="update_calendar" class="btn btn-primary btn-block mt-3" onclick="update_calendar_web()">カレンダー更新</button>
          <button type="button" id="logout"          class="btn btn-logout btn-block mt-3"  onclick="logout_web()"　 　　　　>登録解除</button>
        </div>
        <div class="col-md-5">
          <div class="mt-3">
            <p>※注意書き<br>システムの不具合によって課題が出せなかったなどのトラブルに関しては一切保証できません<br>おねしゃす  by強欲</p>
            <p id="version">バージョン0.9.5(ベータ版)</p>
          </div>
        </div>    
      </div>
    </div>
  </div>
</div>
</div>
</div>
</div>
</body>
<script>
  // ページ読み込み時の処理開始
  window.onload = function() {google.script.run.withSuccessHandler(onload_result).onload();}

  // ページ読み込み時の処理結果
  function onload_result(n) {
    document.getElementById('inResponse').innerHTML = `<center><div class="mt-3">学籍番号[${n[0]}]で登録されています</div></center>`;
    document.getElementById('inCalendar').innerHTML = `<iframe src="https://calendar.google.com/calendar/embed?src=${n[1]}&ctz=Asia%2FTokyo" style="border: 0" width="600" height="500" frameborder="0" scrolling="no"></iframe>`;   
  }

  // カレンダー更新の処理開始
  function update_calendar_web() {
    if (confirm("カレンダーを更新しますか？")) { 
      document.getElementById("update_calendar").disabled = true;
      document.getElementById("logout"         ).disabled = true;
      document.getElementById('inResponse').innerHTML = `<center><div class="mt-3">カレンダーを更新中...</div></center>`;
      google.script.run.withSuccessHandler(update_calendar_result).update_calendar();
    }
  }

  // ログアウト処理開始
  function logout_web() {
    if (confirm("登録を解除しますか？")) {
      document.getElementById("update_calendar").disabled = true;
      document.getElementById("logout"         ).disabled = true;
      document.getElementById('inResponse').innerHTML = `<center><div class="mt-3">カレンダーを削除中...</div></center>`;
      google.script.run.withSuccessHandler(logout_result).logout();
    }    
  }

  // カレンダー更新の処理結果
  function update_calendar_result(n){
    const inResponse = document.getElementById('inResponse');
    if (n[0] == -1) {
      inResponse.innerHTML = `<div id="error" class="loginerrors mt-3"><div class="alert alert-danger" role="alert" data-aria-autofocus="true"><center>すでに登録が解除されています　ページを更新してください</center></div></div>`;
    } else {
      inResponse.innerHTML = `<center><div class="mt-3 alert-success">${n[0]}個のイベントを追加しました。</div></center>`;
      document.getElementById('inCalendar').innerHTML = `<iframe src="https://calendar.google.com/calendar/embed?src=${n[1]}&ctz=Asia%2FTokyo" style="border: 0" width="800" height="600" frameborder="0" scrolling="no"></iframe>`;
    }
    document.getElementById("update_calendar").disabled = false;
    document.getElementById("logout"         ).disabled = false;
  }

  // ログアウトの処理結果
  function logout_result(n) {
    const inResponse = document.getElementById('inResponse');
    if (n == -1) {
      inResponse.innerHTML = `<div id="error" class="loginerrors mt-3"><div class="alert alert-danger" role="alert" data-aria-autofocus="true"><center>すでに登録が解除されています　ページを更新してください</center></div></div>`;
    } else {
      inResponse.innerHTML = `<center><div class="mt-3 alert-success">登録を解除しました　ページを更新してください</div></center>`;
    }
    document.getElementById("update_calendar").disabled = false;
    document.getElementById("logout"         ).disabled = false;
  }
</script>
</html>