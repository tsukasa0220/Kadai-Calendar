<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Kadai-Calendar</title>
    <base target="_top">
    <?!= include('css'); ?>
</head>
<body>
<div role="main">
  <span id="maincontent"></span>
  <div class="my-1 my-sm-5"></div>
<div class="row justify-content-center">
<div class="col-xl-6 col-sm-8 ">
<div class="card">
  <div class="card-block">
    <h1 class="h2 card-header text-center">Kadai-Calendar</h1>
    <div class="card-body"><b>
      <center>
        <div id="inResponse" class="mt-3">　</div>
      </center>
      <div class="row justify-content-md-center">
        <div class="col-md-5">
          <button type="button" id="update_calendar" class="btn btn-green btn-block mt-3" onclick="update_calendar_web()">カレンダー更新</button>
          <button type="button" id="logout"          class="btn btn-red   btn-block mt-3" onclick="logout_web()"　 　　　　>登録解除</button>
        </div>
        <div class="col-md-5">
          <div class="mt-3">
            <p>※注意書き<br>システムの不具合によって課題が出せなかったなどのトラブルに関しては一切保証できません。おねしゃす！<br>リンク先：<a href="https://kadai-moodle.kagawa-u.ac.jp/login/index.php">香川大学Moodle</a><div id="version"></div></p>
          </div>
        </div>    
      </div>
    </div>
  </div>
</div>
</div>
</div>
  <div class="gc-wrap">
    <center>
      <button type="button" id="btn-Calendar" class="btn btn-block mt-3" onclick="on_calendar_web()">カレンダーの表示</button><br>
      <p>PCでカレンダーを利用する場合は<a href="https://chrome.google.com/webstore/detail/checker-plus-for-google-c/hkhggnncdpfibdhinjiegagmopldibha?hl=ja">こちら</a>のChrome拡張機能の利用をおすすめします。（推奨）<br>スマートフォンで利用するにはGoogleカレンダーをインストールしてください。（<a href="https://apps.apple.com/jp/app/google-%E3%82%AB%E3%83%AC%E3%83%B3%E3%83%80%E3%83%BC-%E4%BA%88%E5%AE%9A%E3%82%92%E3%82%B9%E3%83%9E%E3%83%BC%E3%83%88%E3%81%AB%E7%AE%A1%E7%90%86%E3%81%99%E3%82%8B/id909319292">iOS</a>・<a href="https://play.google.com/store/apps/details?id=com.google.android.calendar">Android</a>）</p><br>
      <div id="onCalendar" class="g-calendar"></div>
    </center>
  </div>
</div>
</body>
<script>
  // ページ読み込み時の処理開始
  window.onload = function() {google.script.run.withSuccessHandler(onload_result).onload();}

  // ページ読み込み時の処理結果
  function onload_result(n) {
    document.getElementById('inResponse').innerHTML = `<div class="mt-3">学籍番号[${n[0]}]で登録されています</div>`;
    document.getElementById('version').innerHTML = `Ver${n[2]}（ベータ版）`;
  }

  // カレンダー更新の処理開始
  function update_calendar_web() {
    if (confirm("カレンダーを更新しますか？")) { 
      document.getElementById("update_calendar").disabled = true;
      document.getElementById("logout"         ).disabled = true;
      document.getElementById('inResponse').innerHTML = `<div class="mt-3">カレンダーを更新中...</div>`;
      google.script.run.withSuccessHandler(update_calendar_result).update_calendar();
    }
  }

  // ログアウト処理開始
  function logout_web() {
    if (confirm("登録を解除しますか？")) {
      document.getElementById("update_calendar").disabled = true;
      document.getElementById("logout"         ).disabled = true;
      document.getElementById('inResponse').innerHTML = `<div class="mt-3">カレンダーを削除中...</div>`;
      google.script.run.withSuccessHandler(logout_result).logout();
    }    
  }

  // カレンダー更新の処理結果
  function update_calendar_result(n){
    const inResponse = document.getElementById('inResponse');
    if (n[0] === -1) {
      inResponse.innerHTML = `<div id="error" class="loginerrors mt-3"><div class="alert alert-danger" role="alert" data-aria-autofocus="true">すでに登録が解除されています　ページを更新してください</div></div>`;
    } else if (n[0] === false) {
      inResponse.innerHTML = `<div id="error" class="loginerrors mt-3"><div class="alert alert-danger" role="alert" data-aria-autofocus="true">アクセスエラー：Moodleにアクセスできません</div></div>`;
    } else if (n[0] === 0) {
      inResponse.innerHTML = `<div class="mt-3 alert-success">追加するイベントはありません</div>`;
    } else {
      inResponse.innerHTML = `<div class="mt-3 alert-success">${n[0]}個のイベントを追加しました</div>`;
    }
    document.getElementById("update_calendar").disabled = false;
    document.getElementById("logout"         ).disabled = false;
  }

  // ログアウトの処理結果
  function logout_result(n) {
    const inResponse = document.getElementById('inResponse');
    if (n === -1) {
      inResponse.innerHTML = `<div id="error" class="loginerrors mt-3"><div class="alert alert-danger" role="alert" data-aria-autofocus="true">すでに登録が解除されています　ページを更新してください</div></div>`;
    } else {
      inResponse.innerHTML = `<div class="mt-3 alert-success">登録を解除しました　ページを更新してください（F5を押してください）</div>`;
    }
    document.getElementById("update_calendar").disabled = false;
    document.getElementById("logout"         ).disabled = false;
  }

  // カレンダーの表示ボタン
  function on_calendar_web() {
    google.script.run.withSuccessHandler(on_calendar_result).onload();
  }

  function on_calendar_result(n) {
    document.getElementById('onCalendar').innerHTML = `<iframe src="https://calendar.google.com/calendar/embed?src=${n[1]}&ctz=Asia%2FTokyo" style="border: 0" width="800" height="600" frameborder="0" scrolling="no"></iframe>`;
  }
</script>
</html>